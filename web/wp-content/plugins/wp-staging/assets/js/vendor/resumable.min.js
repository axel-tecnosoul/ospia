!function(){"use strict";var s=function(e){if(!(this instanceof s))return new s(e);if(this.version=1,this.support=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof FileList||!Blob.prototype.webkitSlice&&!Blob.prototype.mozSlice&&!Blob.prototype.slice),!this.support)return!1;var m=this;m.files=[],m.defaults={chunkSize:1048576,forceChunkSize:!1,simultaneousUploads:3,fileParameterName:"file",chunkNumberParameterName:"resumableChunkNumber",chunkSizeParameterName:"resumableChunkSize",currentChunkSizeParameterName:"resumableCurrentChunkSize",totalSizeParameterName:"resumableTotalSize",typeParameterName:"resumableType",identifierParameterName:"resumableIdentifier",fileNameParameterName:"resumableFilename",relativePathParameterName:"resumableRelativePath",totalChunksParameterName:"resumableTotalChunks",dragOverClass:"dragover",throttleProgressCallbacks:.5,query:{},headers:{},preprocess:null,preprocessFile:null,method:"multipart",uploadMethod:"POST",testMethod:"GET",prioritizeFirstAndLastChunk:!1,target:"/",testTarget:null,parameterNamespace:"",testChunks:!0,generateUniqueIdentifier:null,getTarget:null,maxChunkRetries:100,chunkRetryInterval:void 0,permanentErrors:[400,401,403,404,409,415,500,501],maxFiles:void 0,withCredentials:!1,xhrTimeout:0,clearInput:!0,chunkFormat:"blob",setChunkTypeFromFile:!1,maxFilesErrorCallback:function(e,t){var r=m.getOpt("maxFiles");alert("Please upload no more than "+r+" file"+(1===r?"":"s")+" at a time.")},minFileSize:1,minFileSizeErrorCallback:function(e,t){alert(e.fileName||e.name+" is too small, please upload files larger than "+h.formatSize(m.getOpt("minFileSize"))+".")},maxFileSize:void 0,maxFileSizeErrorCallback:function(e,t){alert(e.fileName||e.name+" is too large, please upload files less than "+h.formatSize(m.getOpt("maxFileSize"))+".")},fileType:[],fileTypeErrorCallback:function(e,t){alert(e.fileName||e.name+" has type not allowed, please upload files of type "+m.getOpt("fileType")+".")}},m.opts=e||{},m.getOpt=function(e){var t=this;if(e instanceof Array){var r={};return h.each(e,function(e){r[e]=t.getOpt(e)}),r}if(t instanceof o){if(void 0!==t.opts[e])return t.opts[e];t=t.fileObj}if(t instanceof g){if(void 0!==t.opts[e])return t.opts[e];t=t.resumableObj}if(t instanceof s)return(void 0!==t.opts[e]?t.opts:t.defaults)[e]},m.indexOf=function(e,t){if(e.indexOf)return e.indexOf(t);for(var r=0;r<e.length;r++)if(e[r]===t)return r;return-1},m.events=[],m.on=function(e,t){m.events.push(e.toLowerCase(),t)},m.fire=function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);for(var r=e[0].toLowerCase(),t=0;t<=m.events.length;t+=2)m.events[t]==r&&m.events[t+1].apply(m,e.slice(1)),"catchall"==m.events[t]&&m.events[t+1].apply(null,e);"fileerror"==r&&m.fire("error",e[2],e[1]),"fileprogress"==r&&m.fire("progress")};function t(e){e.currentTarget.classList.remove(m.getOpt("dragOverClass")),h.stopEvent(e),e.dataTransfer&&e.dataTransfer.items?i(e.dataTransfer.items,e):e.dataTransfer&&e.dataTransfer.files&&i(e.dataTransfer.files,e)}function r(e){e.currentTarget.classList.remove(m.getOpt("dragOverClass"))}function n(e){e.preventDefault();var t=e.dataTransfer;0<=m.indexOf(t.types,"Files")?(e.stopPropagation(),t.dropEffect="copy",t.effectAllowed="copy",e.currentTarget.classList.add(m.getOpt("dragOverClass"))):(t.dropEffect="none",t.effectAllowed="none")}var h={stopEvent:function(e){e.stopPropagation(),e.preventDefault()},each:function(e,t){if(void 0!==e.length){for(var r=0;r<e.length;r++)if(!1===t(e[r]))return}else for(r in e)if(!1===t(r,e[r]))return},generateUniqueIdentifier:function(e,t){var r=m.getOpt("generateUniqueIdentifier");if("function"==typeof r)return r(e,t);t=e.webkitRelativePath||e.relativePath||e.fileName||e.name;return e.size+"-"+t.replace(/[^0-9a-zA-Z_-]/gim,"")},contains:function(e,t){var r=!1;return h.each(e,function(e){return e!=t||!(r=!0)}),r},formatSize:function(e){return e<1024?e+" bytes":e<1048576?(e/1024).toFixed(0)+" KB":e<1073741824?(e/1024/1024).toFixed(1)+" MB":(e/1024/1024/1024).toFixed(1)+" GB"},getTarget:function(e,t){var r=m.getOpt("target");if("test"===e&&m.getOpt("testTarget")&&(r="/"===m.getOpt("testTarget")?m.getOpt("target"):m.getOpt("testTarget")),"function"==typeof r)return r(t);e=r.indexOf("?")<0?"?":"&",t=t.join("&");return t&&(r=r+e+t),r}};function f(e,t,r,n){var i,a,s,o,l,u;return e.isFile?e.file(function(e){e.relativePath=t+e.name,r.push(e),n()}):(e.isDirectory?i=e:e instanceof File&&r.push(e),"function"==typeof e.webkitGetAsEntry&&(i=e.webkitGetAsEntry()),i&&i.isDirectory?(a=t+(i=i).name+"/",s=r,o=n,l=i.createReader(),u=[],void function t(){l.readEntries(function(e){return e.length?(u=u.concat(e),t()):void c(u.map(function(e){return f.bind(null,e,a,s)}),o)})}()):("function"==typeof e.getAsFile&&(e=e.getAsFile())instanceof File&&(e.relativePath=t+e.name,r.push(e)),void n()))}function c(e,t){if(!e||0===e.length)return t();e[0](function(){c(e.slice(1),t)})}function i(e,t){var r;e.length&&(m.fire("beforeAdd"),r=[],c(Array.prototype.map.call(e,function(e){var t=e;return"function"==typeof e.webkitGetAsEntry&&(t=e.webkitGetAsEntry()),f.bind(null,t,"",r)}),function(){r.length&&a(r,t)}))}var a=function(e,l){var u=0,f=m.getOpt(["maxFiles","minFileSize","maxFileSize","maxFilesErrorCallback","minFileSizeErrorCallback","maxFileSizeErrorCallback","fileType","fileTypeErrorCallback"]);if(void 0!==f.maxFiles&&f.maxFiles<e.length+m.files.length){if(1!==f.maxFiles||1!==m.files.length||1!==e.length)return f.maxFilesErrorCallback(e,u++),!1;m.removeFile(m.files[0])}function c(){--t||(p.length||d.length)&&window.setTimeout(function(){m.fire("filesAdded",p,d)},0)}var p=[],d=[],t=e.length;h.each(e,function(r){var e=r.name,t=r.type;if(0<f.fileType.length){var n,i=!1;for(n in f.fileType){f.fileType[n]=f.fileType[n].replace(/\s/g,"").toLowerCase();var a=(f.fileType[n].match(/^[^.][^/]+$/)?".":"")+f.fileType[n];if(e.substr(-1*a.length).toLowerCase()===a||-1!==a.indexOf("/")&&(-1!==a.indexOf("*")&&t.substr(0,a.indexOf("*"))===a.substr(0,a.indexOf("*"))||t===a)){i=!0;break}}if(!i)return f.fileTypeErrorCallback(r,u++),!0}if(void 0!==f.minFileSize&&r.size<f.minFileSize)return f.minFileSizeErrorCallback(r,u++),!0;if(void 0!==f.maxFileSize&&r.size>f.maxFileSize)return f.maxFileSizeErrorCallback(r,u++),!0;function s(t){m.getFromUniqueIdentifier(t)?d.push(r):function(){r.uniqueIdentifier=t;var e=new g(m,r,t);m.files.push(e),p.push(e),e.container=void 0!==l?l.srcElement:null,window.setTimeout(function(){m.fire("fileAdded",e,l)},0)}(),c()}var o=h.generateUniqueIdentifier(r,l);o&&"function"==typeof o.then?o.then(function(e){s(e)},function(){c()}):s(o)})};function g(e,t,r){var i=this;i.opts={},i.getOpt=e.getOpt,i._prevProgress=0,i.resumableObj=e,i.file=t,i.fileName=t.fileName||t.name,i.size=t.size,i.relativePath=t.relativePath||t.webkitRelativePath||i.fileName,i.uniqueIdentifier=r,i._pause=!1,i.container="";function a(e,t){switch(e){case"progress":i.resumableObj.fire("fileProgress",i,t);break;case"error":i.abort(),s=!0,i.chunks=[],i.resumableObj.fire("fileError",i,t);break;case"success":if(s)return;i.resumableObj.fire("fileProgress",i,t),i.isComplete()&&i.resumableObj.fire("fileSuccess",i,t);break;case"retry":i.resumableObj.fire("fileRetry",i)}}var s=void(i.preprocessState=0)!==r;return i.chunks=[],i.abort=function(){var t=0;h.each(i.chunks,function(e){"uploading"==e.status()&&(e.abort(),t++)}),0<t&&i.resumableObj.fire("fileProgress",i)},i.cancel=function(){var e=i.chunks;i.chunks=[],h.each(e,function(e){"uploading"==e.status()&&(e.abort(),i.resumableObj.uploadNextChunk())}),i.resumableObj.removeFile(i),i.resumableObj.fire("fileProgress",i)},i.retry=function(){i.bootstrap();var e=!1;i.resumableObj.on("chunkingComplete",function(){e||i.resumableObj.upload(),e=!0})},i.bootstrap=function(){i.abort(),s=!1,i.chunks=[],i._prevProgress=0;for(var e,t=i.getOpt("forceChunkSize")?Math.ceil:Math.floor,r=Math.max(t(i.file.size/i.getOpt("chunkSize")),1),n=0;n<r;n++)e=n,i.chunks.push(new o(i.resumableObj,i,e,a)),i.resumableObj.fire("chunkingProgress",i,e/r);window.setTimeout(function(){i.resumableObj.fire("chunkingComplete",i)},0)},i.progress=function(){if(s)return 1;var t=0,r=!1;return h.each(i.chunks,function(e){"error"==e.status()&&(r=!0),t+=e.progress(!0)}),t=r||.99999<t?1:t,t=Math.max(i._prevProgress,t),i._prevProgress=t},i.isUploading=function(){var t=!1;return h.each(i.chunks,function(e){if("uploading"==e.status())return!(t=!0)}),t},i.isComplete=function(){var r=!1;return 1!==i.preprocessState&&(h.each(i.chunks,function(e){var t=e.status();if("pending"==t||"uploading"==t||1===e.preprocessState)return!(r=!0)}),!r)},i.pause=function(e){i._pause=void 0===e?!i._pause:e},i.isPaused=function(){return i._pause},i.preprocessFinished=function(){i.preprocessState=2,i.upload()},i.upload=function(){var t=!1;if(!1===i.isPaused()){var e=i.getOpt("preprocessFile");if("function"==typeof e)switch(i.preprocessState){case 0:return i.preprocessState=1,e(i),!0;case 1:return!0}h.each(i.chunks,function(e){if("pending"==e.status()&&1!==e.preprocessState)return e.send(),!(t=!0)})}return t},i.markChunksCompleted=function(e){if(i.chunks&&!(i.chunks.length<=e))for(var t=0;t<e;t++)i.chunks[t].markComplete=!0},i.resumableObj.fire("chunkingStart",i),i.bootstrap(),this}function o(e,t,r,n){var l=this;l.opts={},l.getOpt=e.getOpt,l.resumableObj=e,l.fileObj=t,l.fileObjSize=t.size,l.fileObjType=t.file.type,l.offset=r,l.callback=n,l.lastProgressCallback=new Date,l.tested=!1,l.retries=0,l.pendingRetry=!1,l.preprocessState=0,l.markComplete=!1;n=l.getOpt("chunkSize");return l.loaded=0,l.startByte=l.offset*n,l.endByte=Math.min(l.fileObjSize,(l.offset+1)*n),l.fileObjSize-l.endByte<n&&!l.getOpt("forceChunkSize")&&(l.endByte=l.fileObjSize),l.xhr=null,l.test=function(){l.xhr=new XMLHttpRequest;var e=function(e){l.tested=!0;var t=l.status();"success"==t?(l.callback(t,l.message()),l.resumableObj.uploadNextChunk()):l.send()};l.xhr.addEventListener("load",e,!1),l.xhr.addEventListener("error",e,!1),l.xhr.addEventListener("timeout",e,!1);var r=[],n=l.getOpt("parameterNamespace"),e=l.getOpt("query");"function"==typeof e&&(e=e(l.fileObj,l)),h.each(e,function(e,t){r.push([encodeURIComponent(n+e),encodeURIComponent(t)].join("="))}),r=r.concat([["chunkNumberParameterName",l.offset+1],["chunkSizeParameterName",l.getOpt("chunkSize")],["currentChunkSizeParameterName",l.endByte-l.startByte],["totalSizeParameterName",l.fileObjSize],["typeParameterName",l.fileObjType],["identifierParameterName",l.fileObj.uniqueIdentifier],["fileNameParameterName",l.fileObj.fileName],["relativePathParameterName",l.fileObj.relativePath],["totalChunksParameterName",l.fileObj.chunks.length]].filter(function(e){return l.getOpt(e[0])}).map(function(e){return[n+l.getOpt(e[0]),encodeURIComponent(e[1])].join("=")})),l.xhr.open(l.getOpt("testMethod"),h.getTarget("test",r)),l.xhr.timeout=l.getOpt("xhrTimeout"),l.xhr.withCredentials=l.getOpt("withCredentials");e=l.getOpt("headers");"function"==typeof e&&(e=e(l.fileObj,l)),h.each(e,function(e,t){l.xhr.setRequestHeader(e,t)}),l.xhr.send(null)},l.preprocessFinished=function(){l.preprocessState=2,l.send()},l.send=function(){var r,n,i,t,a,e,s,o=l.getOpt("preprocess");if("function"==typeof o)switch(l.preprocessState){case 0:return l.preprocessState=1,void o(l);case 1:return}!l.getOpt("testChunks")||l.tested?(l.xhr=new XMLHttpRequest,l.xhr.upload.addEventListener("progress",function(e){new Date-l.lastProgressCallback>1e3*l.getOpt("throttleProgressCallbacks")&&(l.callback("progress"),l.lastProgressCallback=new Date),l.loaded=e.loaded||0},!1),l.loaded=0,l.pendingRetry=!1,l.callback("progress"),s=function(e){var t=l.status();"success"==t||"error"==t?(l.callback(t,l.message()),l.resumableObj.uploadNextChunk()):(l.callback("retry",l.message()),l.abort(),l.retries++,void 0!==(t=l.getOpt("chunkRetryInterval"))?(l.pendingRetry=!0,setTimeout(l.send,t)):l.send())},l.xhr.addEventListener("load",s,!1),l.xhr.addEventListener("error",s,!1),l.xhr.addEventListener("timeout",s,!1),r=[["chunkNumberParameterName",l.offset+1],["chunkSizeParameterName",l.getOpt("chunkSize")],["currentChunkSizeParameterName",l.endByte-l.startByte],["totalSizeParameterName",l.fileObjSize],["typeParameterName",l.fileObjType],["identifierParameterName",l.fileObj.uniqueIdentifier],["fileNameParameterName",l.fileObj.fileName],["relativePathParameterName",l.fileObj.relativePath],["totalChunksParameterName",l.fileObj.chunks.length]].filter(function(e){return l.getOpt(e[0])}).reduce(function(e,t){return e[l.getOpt(t[0])]=t[1],e},{}),"function"==typeof(e=l.getOpt("query"))&&(e=e(l.fileObj,l)),h.each(e,function(e,t){r[e]=t}),s=l.fileObj.file.slice?"slice":l.fileObj.file.mozSlice?"mozSlice":l.fileObj.file.webkitSlice?"webkitSlice":"slice",e=l.fileObj.file[s](l.startByte,l.endByte,l.getOpt("setChunkTypeFromFile")?l.fileObj.file.type:""),a=null,n=[],i=l.getOpt("parameterNamespace"),"octet"===l.getOpt("method")?(a=e,h.each(r,function(e,t){n.push([encodeURIComponent(i+e),encodeURIComponent(t)].join("="))})):(a=new FormData,h.each(r,function(e,t){a.append(i+e,t),n.push([encodeURIComponent(i+e),encodeURIComponent(t)].join("="))}),"blob"==l.getOpt("chunkFormat")?a.append(i+l.getOpt("fileParameterName"),e,l.fileObj.fileName):"base64"==l.getOpt("chunkFormat")&&((t=new FileReader).onload=function(e){a.append(i+l.getOpt("fileParameterName"),t.result),l.xhr.send(a)},t.readAsDataURL(e))),s=h.getTarget("upload",n),e=l.getOpt("uploadMethod"),l.xhr.open(e,s),"octet"===l.getOpt("method")&&l.xhr.setRequestHeader("Content-Type","application/octet-stream"),l.xhr.timeout=l.getOpt("xhrTimeout"),l.xhr.withCredentials=l.getOpt("withCredentials"),"function"==typeof(s=l.getOpt("headers"))&&(s=s(l.fileObj,l)),h.each(s,function(e,t){l.xhr.setRequestHeader(e,t)}),"blob"==l.getOpt("chunkFormat")&&l.xhr.send(a)):l.test()},l.abort=function(){l.xhr&&l.xhr.abort(),l.xhr=null},l.status=function(){return l.pendingRetry?"uploading":l.markComplete?"success":l.xhr?l.xhr.readyState<4?"uploading":200==l.xhr.status||201==l.xhr.status?"success":h.contains(l.getOpt("permanentErrors"),l.xhr.status)||l.retries>=l.getOpt("maxChunkRetries")?"error":(l.abort(),"pending"):"pending"},l.message=function(){return l.xhr?l.xhr.responseText:""},l.progress=function(e){void 0===e&&(e=!1);var t=e?(l.endByte-l.startByte)/l.fileObjSize:1;if(l.pendingRetry)return 0;switch(l.xhr&&l.xhr.status||l.markComplete||(t*=.95),l.status()){case"success":case"error":return+t;case"pending":return 0*t;default:return l.loaded/(l.endByte-l.startByte)*t}},this}return m.uploadNextChunk=function(){var t=!1;if(m.getOpt("prioritizeFirstAndLastChunk")&&(h.each(m.files,function(e){return e.chunks.length&&"pending"==e.chunks[0].status()&&0===e.chunks[0].preprocessState?(e.chunks[0].send(),!(t=!0)):1<e.chunks.length&&"pending"==e.chunks[e.chunks.length-1].status()&&0===e.chunks[e.chunks.length-1].preprocessState?(e.chunks[e.chunks.length-1].send(),!(t=!0)):void 0}),t))return!0;if(h.each(m.files,function(e){if(t=e.upload())return!1}),t)return!0;var r=!1;return h.each(m.files,function(e){if(!e.isComplete())return!(r=!0)}),r||m.fire("complete"),!1},m.assignBrowse=function(e,r){void 0===e.length&&(e=[e]),h.each(e,function(e){var t;"INPUT"===e.tagName&&"file"===e.type?t=e:((t=document.createElement("input")).setAttribute("type","file"),t.style.display="none",e.addEventListener("click",function(){t.style.opacity=0,t.style.display="block",t.focus(),t.click(),t.style.display="none"},!1),e.appendChild(t));e=m.getOpt("maxFiles");void 0===e||1!=e?t.setAttribute("multiple","multiple"):t.removeAttribute("multiple"),r?t.setAttribute("webkitdirectory","webkitdirectory"):t.removeAttribute("webkitdirectory");e=m.getOpt("fileType");void 0!==e&&1<=e.length?t.setAttribute("accept",e.map(function(e){return(e=e.replace(/\s/g,"").toLowerCase()).match(/^[^.][^/]+$/)&&(e="."+e),e}).join(",")):t.removeAttribute("accept"),t.addEventListener("change",function(e){a(e.target.files,e),m.getOpt("clearInput")&&(e.target.value="")},!1)})},m.assignDrop=function(e){void 0===e.length&&(e=[e]),h.each(e,function(e){e.addEventListener("dragover",n,!1),e.addEventListener("dragenter",n,!1),e.addEventListener("dragleave",r,!1),e.addEventListener("drop",t,!1)})},m.unAssignDrop=function(e){void 0===e.length&&(e=[e]),h.each(e,function(e){e.removeEventListener("dragover",n),e.removeEventListener("dragenter",n),e.removeEventListener("dragleave",r),e.removeEventListener("drop",t)})},m.isUploading=function(){var t=!1;return h.each(m.files,function(e){if(e.isUploading())return!(t=!0)}),t},m.upload=function(){if(!m.isUploading()){m.fire("uploadStart");for(var e=1;e<=m.getOpt("simultaneousUploads");e++)m.uploadNextChunk()}},m.pause=function(){h.each(m.files,function(e){e.abort()}),m.fire("pause")},m.cancel=function(){m.fire("beforeCancel");for(var e=m.files.length-1;0<=e;e--)m.files[e].cancel();m.fire("cancel")},m.progress=function(){var t=0,r=0;return h.each(m.files,function(e){t+=e.progress()*e.size,r+=e.size}),0<r?t/r:0},m.addFile=function(e,t){a([e],t)},m.addFiles=function(e,t){a(e,t)},m.removeFile=function(e){for(var t=m.files.length-1;0<=t;t--)m.files[t]===e&&m.files.splice(t,1)},m.getFromUniqueIdentifier=function(t){var r=!1;return h.each(m.files,function(e){e.uniqueIdentifier==t&&(r=e)}),r},m.getSize=function(){var t=0;return h.each(m.files,function(e){t+=e.size}),t},m.handleDropEvent=function(e){t(e)},m.handleChangeEvent=function(e){a(e.target.files,e),e.target.value=""},m.updateQuery=function(e){m.opts.query=e},this};"undefined"!=typeof module?(module.exports=s,module.exports.Resumable=s):"function"==typeof define&&define.amd?define(function(){return s}):window.Resumable=s}();
